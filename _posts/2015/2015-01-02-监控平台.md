---
layout: post
title: "监控平台"
category: 
tags: []
---
{% include JB/setup %}

监控是一个平台，它包括数据收集，存储，异常检测，异常处理，异常通知，展示，异常原因及解决办法记录，tracing。

# 目标

监控平台的目标有以下：

* 业务数据收集：PV，UV，留存率等，最上层的数据，高层所关心的指标。用于评价公司整体的发展情况。
* 性能调优：在分布式环境下，一个 URL 请求的处理跨越多台机器，如何知道系统的瓶颈在哪？开发者关心。
* 故障定位：有故障时怎么快速找到并解决它。开发者关心。
* 系统运行是否正常：系统各组件是否正常运行？开发者关心。
* 容量规划：现在的资源利用情况怎么样？何时需要给某个服务加资源，何时需要买服务器？运维关心。

# 各组件功能

* 异常检测： 把 time series 数据输入 [skyline](https://github.com/etsy/skyline)，自动检测异常点。
* 异常处理：
    * 能自动恢复的，自动恢复
    * 对于每个异常点，生成一个合适的消息体，然后把异常点送入异常通知系统。“生成合适的消息体”是指，对于每个异常点，可能有一些相关的数据，有利于开发者进行故障定位。如生成该异常点的机器的 load，memory等数据，在通知中包含这些信息能加快故障定位
    
* 异常通知：检测出异常点后，将异常以合适的媒介通知给合适的人，该组件以下面的模式运作：
    * 维护每个人的联系方式，他们所关心的 tag，如服务名是什么，由开发者自己定义符合什么规则的异常需要通知给他
    * 从异常检测组件得到异常点列表
    * 每个异常点对应的 metric，都有 tag，匹配每个人规则，符合规则就把该异常的消息体发送给他

* 异常原因及解决办法记录：一次故障得到解决后，其经验需要记录下来，有利于以后差错。
* [tracing](https://github.com/twitter/zipkin)：性能调优利器

## 收集

* collectd：收集系统指标如 CPU load，memory，disk usage，5.4.1 有 statsd 插件，用于收集应用的计时和计数数据。
* heka：通用数据采集和处理，可用于解析 nginx 日志，各状态码的计数，以及把日志发给 elasticsearch 用于实时搜索。
* pstatsd：python statsd 客户端库，应用程序计时和计数。
* kids：日志收集。

collectd 有很多插件，而 heka 的潜力也是很大，应用程序的计时和计数还不是特别积极和完善。

日志方面，应该如下组织：

* Transaction：表示持续一段时间的事件，如 URL 请求，RPC 调用。Transaction具有以下属性：
    
    * 类型：如 URL，RPC，SQL，或者 REDIS，一般用两级，如 URL-Handler，RPC-Service
    * 一系列 key-value 对。用于进一步表明 Transaction 的属性
    * 起止时间
    * 成功还是失败

* Event：表示某一时刻发生的值得注意的事件，如异常。Event 相当于平常的日志概念，它具有如下属性：

    * key-value 对
    * 消息体
    * timestamp
    * 状态：error，warning，info

## 存储

* Influxdb：metric 的存储

Metric 的序列化格式将不再是 `graphite protocol`：

    name value timestamp

一个 Metric 会有很多 tag，搜索 Metric 的时候可以通过 tag 搜索。这将导致以下改变：

* statsd library：应用程序可以为每个 Metric 加上 key-value 对了。
* 用于收集和聚合的 agent：部署在每台机器上的 statsd 可能会变，或者，statsd 客户端将 tag 映射到 metric 的名字上去，然后在存储端，再从名字解析出各 tag
* UI：可以通过 tag 查询指标

