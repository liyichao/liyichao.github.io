<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Oracle 数据库整理表碎片</title>
    <meta name="author" content="kyle x lau" />
    <link href="http://kyle.xlau.org/atom.xml" rel="alternate" title="liyichao's Weblog" type="application/atom+xml" />

    <!-- Homepage CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="/assets/css/bootstrap-responsive.css" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="/assets/css/app.css" type="text/css" media="screen" charset="utf-8" />

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/assets/css/syntax.css" type="text/css" media="screen" charset="utf-8" />

    <link rel="shortcut icon" href="assets/ico/favicon.ico">
      <!-- Fonts -->
      <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
      </head>

      <body>
	<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand" href="/">Kylexlau's Weblog</a>
	<ul class="nav">
	  <li class="active"><a href="/">Home</a></li>
	  <li ><a href="/archive.html">Archive</a></li>
	  <li ><a href="/categories.html">Categories</a></li>
	  <li ><a href="/sitemap.html">Sitemap</a></li>
	  <li ><a href="/about.html">About</a></li>
	</ul>
	<ul class="nav pull-right">
	  <li ><a href="/atom.xml">Subscribe</a></li>
	</ul>
    </div>
  </div>
</div>

	<div class="container">
	  <div id="post">
<h1>
  <a href="/posts/table-fragmentation.html">Oracle 数据库整理表碎片</a>
</h1>
<div class="authoring">
  March 14, 2012
</div>

<h2>表碎片的来源</h2>

<p>当针对一个表的删除操作很多时，表会产生大量碎片。删除操作释放的空间不会被插入操作立即重用，甚至永远也不会被重用。</p>

<h2>怎样确定是否有表碎片</h2>

<pre><code>-- 收集表统计信息
SQL&gt; exec dbms_stats.gather_table_stats(ownname=&gt;'SCHEMA_NAME',tabname=&gt; 'TABLE_NAME');

-- 确定碎片程度
SQL&gt; SELECT table_name, ROUND ((blocks * 8), 2) "高水位空间 k",
   ROUND ((num_rows * avg_row_len / 1024), 2) "真实使用空间 k",
   ROUND ((blocks * 10 / 100) * 8, 2) "预留空间(pctfree) k",
   ROUND ((  blocks * 8
           - (num_rows * avg_row_len / 1024)
           - blocks * 8 * 10 / 100
          ),
          2
         ) "浪费空间 k"
  FROM dba_tables
  WHERE table_name = 'TABLE_NAME';
</code></pre>

<p>或者使用如下<a href="https://gist.github.com/c771b0eca31bce66f785">gist</a>中的脚本找出某个 Schema 中表碎片超过25%的表。使用此脚本前，先确定 Schema 中表统计信息收集完整。</p>

<pre><code>-- 查看表上次收集统计信息时间
select table_name,last_analyzed from dba_tables where owner = 'SCHEMA_NAME'

-- 收集整个 Schema 中对象的统计信息
SQL&gt; exec dbms_stats.gather_schema_stats(ownname=&gt;'SCHEMA_NAME');
</code></pre>

<h2>为什么要整理表碎片</h2>

<p>Oracle 对数据段的管理有一个高水位(HWM, High Water Mark)的概念。高水位是数据段中使用过和未使用过的数据块的分界线。高水位以下的数据块是曾使用过的，以上的是从未被使用或初始化过的。</p>

<p>当 Oracle 进行全表扫描(FTS, Full table scan)的操作时，它会读高水位下的所有数据块。如果高水位下还有很多空闲空间（碎片），读取这些空闲数据块会降低操作的性能。</p>

<h3>行链接和行迁移</h3>

<ul>
<li>行链接 Row Chaining：当插入数据量大的行的，如果一个Block不能存放一条
记录，该记录的一部分会存储到同个Extent中的其他Block，这些block形成一
个数据块链。</li>
<li>行迁移 Row Migration：当Update的时候导致记录长度增加了，存储的Block已
经满了，就会发生行迁移。Oracle会迁移整行数据到一个能够存储下整行数据
的Block中，迁移的原始指针指向新的存放行数据的Block，ROWID不变。</li>
</ul>


<p>当数据行发生链接（chain）或迁移（migrate）时，对其访问将会造成 I/O 性能
降低，因为Oracle为获取这些数据行的数据，必须访问更多的数据块（data
block）。</p>

<h3>表碎片导致的问题</h3>

<ul>
<li>查询响应时间(尤其是全表扫描)变慢</li>
<li>产生大量行迁移</li>
<li>浪费空间</li>
</ul>


<p>整理表碎片对基于索引的查询不会有太大性能提升。</p>

<h2>如何整理表碎片</h2>

<h3>10g之前</h3>

<p>两种方法：</p>

<ul>
<li>导出表，删除表，再导入表</li>
<li><code>alter table move</code></li>
</ul>


<p>一般选择第二种，需要重建索引。</p>

<h3>10g后</h3>

<p>从 10g 开始，提供一个 <code>shrink</code> 命令，需要表空间是基于自动段管理的。</p>

<p>可以分成两步操作：</p>

<pre><code>-- 整理表，不影响DML操作
SQL&gt; alter table TABLE_NAME shrink space compact;

-- 重置高水位，此时不能有DML操作
SQL&gt; alter table TABLE_NAME shrink space;
</code></pre>

<p>也可以一步到位：</p>

<pre><code>-- 整理表，并重置高水位
SQL&gt; alter table TABLE_NAME shrink space;
</code></pre>

<h3>shrink 的优势：</h3>

<ul>
<li>不需要重建索引。</li>
<li>可以在线操作。</li>
<li>不需要空闲空间，<code>alter move</code>需要跟当前表一样大小的空闲空间。</li>
</ul>


</div>

<div id="related">
  <h2>Random Posts</h2>
  <ul class="posts">
    
      <li><span>08 Oct 2013</span> &raquo; <a href="/posts/first-post.html">stat</a></li>
    
      <li><span>26 Aug 2013</span> &raquo; <a href="/posts/aix-large-pages.html">Oracle 数据库在 AIX 平台上启用大内存页</a></li>
    
      <li><span>05 Jul 2012</span> &raquo; <a href="/posts/oracle-data-guard-part2.html">Oracle 11g Data Guard 物理备库快速配置指南（下）</a></li>
    
      <li><span>26 Jun 2012</span> &raquo; <a href="/posts/oracle-data-guard-part1.html">Oracle 11g Data Guard 物理备库快速配置指南（上）</a></li>
    
      <li><span>13 Apr 2012</span> &raquo; <a href="/posts/linux-sar.html">Linux 下使用 Sar 简介</a></li>
    
  </ul>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'xlau';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


	  <div id="footer">
  Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> and <a href="http://twitter.github.com/bootstrap/">Bootstrap</a>.  Last updated at 2013-10-08 14:11:33 +0800.
</div>

	</div>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="/assets/js/app.js"></script>
	<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-4770949-2']);
  _gaq.push(['_setDomainName', 'xlau.org']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
      </body>
</html>
